<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Pro + Monthly Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6366f1; --income: #10b981; --expense: #f43f5e; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        nav { background: white; padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .nav-brand { font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .nav-buttons { display: flex; gap: 10px; align-items: center; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card p { font-size: 1.8rem; font-weight: 800; margin: 10px 0 0; }
        .visual-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        .chart-container { height: 300px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .btn { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; font-weight: 500; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-export { background: #0f172a; color: white; border: none; }
        .month-picker { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; font-weight: 600; color: var(--text); }
        .btn-edit { background: #fef9c3; border: none; padding: 5px 10px; border-radius: 4px; }
        .btn-delete { background: #fee2e2; border: none; padding: 5px 10px; border-radius: 4px; color: #991b1b; }
        .hidden { display: none; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: inherit; }
    </style>
</head>
<body>

<nav>
    <div class="nav-brand">ANALYTICS DASHBOARD</div>
    <div class="nav-buttons">
        <input type="month" id="filterMonth" class="month-picker" onchange="renderDashboard()">
        <button class="btn btn-export" onclick="exportMonthlyCSV()">Download CSV</button>
        <button class="btn btn-primary" onclick="prepareNewEntry()">+ Entry</button>
    </div>
</nav>

<div class="container">
    <div id="dashboardPage" class="page active">
        <div class="stats-grid">
            <div class="card stat-card"><h3>Income</h3><p style="color:var(--income)" id="dashIncome">$0</p></div>
            <div class="card stat-card"><h3>Expenses</h3><p style="color:var(--expense)" id="dashExpense">$0</p></div>
            <div class="card stat-card"><h3>Savings</h3><p id="dashBalance" style="color:var(--primary)">$0</p></div>
        </div>

        <div class="visual-row">
            <div class="card">
                <h3>Monthly Spending</h3>
                <div class="chart-container"><canvas id="expenseChart"></canvas></div>
            </div>
            <div class="card">
                <h3>Transactions</h3>
                <div style="overflow-x: auto; max-height: 400px;">
                    <table>
                        <thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Action</th></tr></thead>
                        <tbody id="historyBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="inputPage" class="page">
        <div class="card" style="max-width:500px; margin:auto;">
            <h2 id="formTitle">Add Transaction</h2>
            <input type="hidden" id="editIndex" value="-1">
            <div class="form-group"><label>Date</label><input type="date" id="date"></div>
            <div class="form-group"><label>Type</label><select id="type" onchange="updateCategories()"><option value="Income">Income</option><option value="Expense">Expense</option></select></div>
            <div class="form-group"><label>Category</label><select id="category" onchange="checkOther()"></select></div>
            <div id="otherCategoryWrapper" class="form-group hidden"><label>Custom Name</label><input type="text" id="otherCategoryText"></div>
            <div class="form-group"><label>Amount ($)</label><input type="number" id="amount" step="0.01"></div>
            <div class="form-group"><label>Description</label><textarea id="description"></textarea></div>
            <div style="display:flex; gap: 10px;">
                <button class="btn" style="flex:1" onclick="showPage('dashboardPage')">Cancel</button>
                <button class="btn btn-primary" style="flex:2" onclick="saveEntry()">Save Transaction</button>
            </div>
        </div>
    </div>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('myFinances_v4')) || [];
    let myChart = null;

    const expenseCategories = ["House Rent", "Grocery", "Medicine", "Conveyance", "Travel", "Food", "Shopping", "Fruits", "Donations", "Other"];
    const incomeCategories = ["Salary", "Business", "Freelance", "Other"];

    // Set default month to current month on load
    window.onload = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('filterMonth').value = `${year}-${month}`;
        renderDashboard();
    };

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(pageId === 'dashboardPage') renderDashboard();
    }

    function updateCategories(selectedCat = null) {
        const type = document.getElementById('type').value;
        const list = type === 'Income' ? incomeCategories : expenseCategories;
        const catSelect = document.getElementById('category');
        catSelect.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
        if(selectedCat) {
            catSelect.value = list.includes(selectedCat) ? selectedCat : "Other";
            if(catSelect.value === "Other") document.getElementById('otherCategoryText').value = selectedCat;
        }
        checkOther();
    }

    function checkOther() {
        const isOther = document.getElementById('category').value === 'Other';
        document.getElementById('otherCategoryWrapper').classList.toggle('hidden', !isOther);
    }

    function prepareNewEntry() {
        document.getElementById('editIndex').value = "-1";
        document.getElementById('formTitle').innerText = "New Transaction";
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('amount').value = '';
        document.getElementById('description').value = '';
        updateCategories();
        showPage('inputPage');
    }

    function saveEntry() {
        const idx = parseInt(document.getElementById('editIndex').value);
        const amount = parseFloat(document.getElementById('amount').value);
        if(!amount) return alert("Enter amount");
        const categoryVal = document.getElementById('category').value;
        const finalCategory = categoryVal === 'Other' ? document.getElementById('otherCategoryText').value : categoryVal;

        const entry = {
            date: document.getElementById('date').value,
            type: document.getElementById('type').value,
            category: finalCategory || "Other",
            amount: amount,
            description: document.getElementById('description').value
        };

        if(idx > -1) transactions[idx] = entry; 
        else transactions.push(entry);

        localStorage.setItem('myFinances_v4', JSON.stringify(transactions));
        showPage('dashboardPage');
    }

    function deleteEntry(i) {
        if(confirm("Delete this record?")) {
            transactions.splice(i, 1);
            localStorage.setItem('myFinances_v4', JSON.stringify(transactions));
            renderDashboard();
        }
    }

    function editEntry(i) {
        const t = transactions[i];
        document.getElementById('editIndex').value = i;
        document.getElementById('formTitle').innerText = "Edit Transaction";
        document.getElementById('date').value = t.date;
        document.getElementById('type').value = t.type;
        document.getElementById('amount').value = t.amount;
        document.getElementById('description').value = t.description;
        updateCategories(t.category);
        showPage('inputPage');
    }

    function renderDashboard() {
        const filterVal = document.getElementById('filterMonth').value; // YYYY-MM
        const body = document.getElementById('historyBody');
        let inc = 0, exp = 0, catMap = {};
        body.innerHTML = '';

        const filtered = transactions.filter(t => t.date.startsWith(filterVal))
                                    .sort((a,b) => new Date(b.date) - new Date(a.date));

        filtered.forEach((t) => {
            const originalIndex = transactions.indexOf(t);
            if(t.type === 'Income') inc += t.amount;
            else {
                exp += t.amount;
                catMap[t.category] = (catMap[t.category] || 0) + t.amount;
            }
            body.innerHTML += `<tr><td>${t.date}</td><td>${t.category}</td>
                <td style="color:${t.type==='Income'?'var(--income)':'var(--expense)'}">${t.type==='Income'?'+':'-'}$${t.amount.toFixed(2)}</td>
                <td><button class="btn-edit" onclick="editEntry(${originalIndex})">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteEntry(${originalIndex})">üóëÔ∏è</button></td></tr>`;
        });

        document.getElementById('dashIncome').innerText = `$${inc.toFixed(2)}`;
        document.getElementById('dashExpense').innerText = `$${exp.toFixed(2)}`;
        document.getElementById('dashBalance').innerText = `$${(inc - exp).toFixed(2)}`;
        updateChart(catMap);
    }

    function updateChart(data) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if(myChart) myChart.destroy();
        const labels = Object.keys(data);
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: Object.values(data), backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#fbbf24', '#a855f7', '#06b6d4', '#f97316'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function exportMonthlyCSV() {
        const filterVal = document.getElementById('filterMonth').value;
        const filtered = transactions.filter(t => t.date.startsWith(filterVal));
        
        if (filtered.length === 0) return alert("No data for this month to export");

        let inc = 0, exp = 0;
        filtered.forEach(t => t.type === 'Income' ? inc += t.amount : exp += t.amount);

        let csv = `Financial Report for ${filterVal}\n`;
        csv += `Total Income,${inc.toFixed(2)}\n`;
        csv += `Total Expenses,${exp.toFixed(2)}\n`;
        csv += `Net Savings,${(inc - exp).toFixed(2)}\n\n`;
        csv += "Date,Type,Category,Amount,Description\n";

        filtered.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            csv += `${t.date},${t.type},${t.category},${t.amount},"${t.description.replace(/"/g, '""')}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `Finance_Report_${filterVal}.csv`);
        link.click();
    }
</script>
</body>
</html>
