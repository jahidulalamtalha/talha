<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceMaster Pro (Cloud)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        aside {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            font-weight: 500;
            transition: 0.2s;
            margin-bottom: 5px;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item i { font-size: 1.2rem; }

        /* CLOUD STATUS INDICATOR */
        .status-box { margin-top: auto; font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 10px; border-radius: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.online { background: #10b981; box-shadow: 0 0 5px #10b981; }

        /* MAIN CONTENT */
        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .controls { display: flex; gap: 15px; }

        /* CARDS */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; }
        .stat-value { font-size: 2rem; font-weight: 800; letter-spacing: -1px; }
        
        /* BUDGET BAR */
        .budget-container { margin-top: 10px; }
        .progress-bar-bg { background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }

        /* TABLES & CHARTS */
        .chart-box { height: 300px; position: relative; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 10px; color: var(--text-muted); font-size: 0.85rem; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        tr:hover td { background: #f8fafc; }
        
        /* BUTTONS & INPUTS */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4); }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-icon { padding: 8px; border-radius: 6px; border: none; cursor: pointer; background: transparent; }
        .btn-icon:hover { background: #f1f5f9; }

        input, select, textarea { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; font-family: inherit; font-size: 0.95rem; }
        input:focus { border-color: var(--primary); }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 500px; border-radius: 16px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
        .hidden { display: none; }

        /* UTILS */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-inc { background: #d1fae5; color: #065f46; }
        .badge-exp { background: #fee2e2; color: #991b1b; }
        .cat-icon { width: 30px; height: 30px; border-radius: 50%; background: #f1f5f9; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 1.1rem; }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            aside { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; border-bottom: 1px solid #ddd; border-right: none; }
            .status-box { display: none; }
            main { padding: 15px; }
            .grid-3, .grid-2 { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .controls { width: 100%; flex-wrap: wrap; }
            .modal { width: 95%; }
        }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        <i class="ph ph-chart-polar"></i> FinancePro
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard')">
        <i class="ph ph-squares-four"></i> Dashboard
    </div>
    <div class="nav-item" onclick="openSettings()">
        <i class="ph ph-gear"></i> Settings / Data
    </div>
    <div class="status-box">
        <div class="dot" id="cloudDot"></div>
        <span id="cloudText">Connecting...</span>
    </div>
</aside>

<main>
    <div class="header">
        <div>
            <h1>Overview</h1>
            <p style="color:var(--text-muted); margin:0;">Track your financial health</p>
        </div>
        <div class="controls">
            <input type="month" id="filterMonth" style="width: auto;" onchange="renderDashboard()">
            <button class="btn btn-outline" onclick="exportCSV()"><i class="ph ph-download-simple"></i> Export CSV</button>
            <button class="btn btn-primary" onclick="openModal()"><i class="ph ph-plus"></i> Add Entry</button>
        </div>
    </div>

    <div class="grid-3">
        <div class="card">
            <div class="stat-label">Total Income</div>
            <div class="stat-value text-green" id="dispIncome">$0.00</div>
        </div>
        <div class="card">
            <div class="stat-label">Total Expenses</div>
            <div class="stat-value text-red" id="dispExpense">$0.00</div>
            <div class="budget-container">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                    <span id="budgetMsg">Budget: $0</span>
                    <span id="budgetPct">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="budgetBar"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="stat-label">Net Savings</div>
            <div class="stat-value" id="dispBalance" style="color: var(--primary)">$0.00</div>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h3>Income vs Expense</h3>
            <div class="chart-box"><canvas id="barChart"></canvas></div>
        </div>
        <div class="card">
            <h3>Expense Breakdown</h3>
            <div class="chart-box"><canvas id="doughnutChart"></canvas></div>
        </div>
    </div>

    <div class="card">
        <h3>Recent Transactions</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="txList"></tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal-overlay" id="entryModal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="modalTitle" style="margin:0">New Transaction</h2>
            <button class="btn-icon" onclick="closeModal()"><i class="ph ph-x" style="font-size:1.5rem"></i></button>
        </div>
        
        <input type="hidden" id="editId">
        
        <div class="form-grid">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="inpDate">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="inpType" onchange="updateCategories()">
                    <option value="Expense">Expense</option>
                    <option value="Income">Income</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Category</label>
            <select id="inpCategory" onchange="checkOther()"></select>
        </div>

        <div class="form-group hidden" id="divOther">
            <label>Custom Category Name</label>
            <input type="text" id="inpOther" placeholder="e.g. Subscription">
        </div>

        <div class="form-group">
            <label>Amount</label>
            <input type="number" id="inpAmount" step="0.01" placeholder="0.00">
        </div>

        <div class="form-group">
            <label>Description (Optional)</label>
            <textarea id="inpDesc" rows="2"></textarea>
        </div>

        <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="saveTransaction()">Save Record</button>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">Settings & Data</h2>
            <button class="btn-icon" onclick="closeSettings()"><i class="ph ph-x" style="font-size:1.5rem"></i></button>
        </div>

        <div class="form-group">
            <label>Monthly Budget Limit ($)</label>
            <input type="number" id="setBudget" placeholder="e.g. 2000">
            <small style="color:var(--text-muted)">Set to 0 to disable budget tracking.</small>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        
        <hr style="margin: 20px 0; border:none; border-top:1px solid #e2e8f0;">
        
        <h3>Data Management</h3>
        <p style="font-size:0.8rem; color:var(--text-muted)">Data is now synced to Cloud automatically.</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-outline" onclick="downloadJSON()"><i class="ph ph-download"></i> Backup File</button>
            <button class="btn btn-outline" onclick="document.getElementById('fileUpload').click()"><i class="ph ph-upload"></i> Restore File</button>
            <input type="file" id="fileUpload" style="display:none" onchange="restoreData(this)">
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION (Your Specific Keys) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBkPRveBq5gwuiXS6l4qIQOYm7jm5fNQcA",
        authDomain: "financeapp-599c5.firebaseapp.com",
        projectId: "financeapp-599c5",
        storageBucket: "financeapp-599c5.firebasestorage.app",
        messagingSenderId: "657979034906",
        appId: "1:657979034906:web:c74d5c2f30e7a0292870a3",
        measurementId: "G-2VF5LLQP5L"
    };

    // Initialize Firebase
    if(firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- STATE MANAGEMENT ---
    let transactions = [];
    let appSettings = { budget: 0 };
    
    // UI References
    const cloudDot = document.getElementById('cloudDot');
    const cloudText = document.getElementById('cloudText');

    // --- CONFIGURATION ---
    const categories = {
        Expense: {
            "House Rent": "ðŸ ", "Grocery": "ðŸ›’", "Medicine": "ðŸ’Š", "Conveyance": "ðŸšŒ", 
            "Travel": "âœˆï¸", "Food": "ðŸ½ï¸", "Shopping": "ðŸ›ï¸", "Fruits": "ðŸŽ", 
            "Donations": "ðŸ¤", "Other": "ðŸ“¦"
        },
        Income: {
            "Salary": "ðŸ’°", "Business": "ðŸ’¼", "Freelance": "ðŸ’»", "Gift": "ðŸŽ", "Other": "ðŸ“¦"
        }
    };

    let chartInstanceDoughnut = null;
    let chartInstanceBar = null;

    // --- INITIALIZATION ---
    window.onload = () => {
        const now = new Date();
        document.getElementById('filterMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        
        // Connect to Cloud
        initFirebaseConnection();
    };

    // --- FIREBASE LOGIC ---
    function initFirebaseConnection() {
        cloudText.innerText = "Syncing...";
        
        // Listen to "finance_data" collection, document "user_data"
        db.collection("finance_data").doc("user_data").onSnapshot((doc) => {
            cloudDot.classList.add('online');
            cloudText.innerText = "Cloud Active";
            
            if (doc.exists) {
                const data = doc.data();
                transactions = data.list || [];
                appSettings = data.settings || { budget: 0 };
                
                // Update Budget UI from Cloud data
                document.getElementById('setBudget').value = appSettings.budget;
                renderDashboard();
            } else {
                console.log("New database. Waiting for entry.");
            }
        }, (error) => {
            console.error("Sync error:", error);
            cloudDot.classList.remove('online');
            cloudDot.style.background = "red";
            cloudText.innerText = "Offline/Error";
        });
    }

    function saveToCloud() {
        cloudText.innerText = "Saving...";
        db.collection("finance_data").doc("user_data").set({
            list: transactions,
            settings: appSettings
        })
        .then(() => {
            cloudText.innerText = "Saved";
            setTimeout(() => cloudText.innerText = "Cloud Active", 2000);
        })
        .catch((err) => {
            alert("Error saving to cloud: " + err);
        });
    }

    // --- MODAL CONTROLS ---
    function openModal(id = null) {
        document.getElementById('entryModal').classList.add('open');
        document.getElementById('editId').value = id || "";
        document.getElementById('modalTitle').innerText = id ? "Edit Transaction" : "New Transaction";
        
        if (!id) {
            document.getElementById('inpDate').valueAsDate = new Date();
            document.getElementById('inpAmount').value = '';
            document.getElementById('inpDesc').value = '';
            document.getElementById('inpType').value = 'Expense';
            updateCategories();
        } else {
            const t = transactions.find(x => x.id == id);
            document.getElementById('inpDate').value = t.date;
            document.getElementById('inpType').value = t.type;
            document.getElementById('inpAmount').value = t.amount;
            document.getElementById('inpDesc').value = t.description;
            updateCategories(t.category);
        }
    }
    function closeModal() { document.getElementById('entryModal').classList.remove('open'); }
    
    function openSettings() { document.getElementById('settingsModal').classList.add('open'); }
    function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }

    // --- FORM LOGIC ---
    function updateCategories(selected = null) {
        const type = document.getElementById('inpType').value;
        const catSelect = document.getElementById('inpCategory');
        const list = Object.keys(categories[type]);
        
        catSelect.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
        
        if (selected) {
            if (list.includes(selected)) {
                catSelect.value = selected;
            } else {
                catSelect.value = "Other";
                document.getElementById('inpOther').value = selected;
            }
        }
        checkOther();
    }

    function checkOther() {
        const isOther = document.getElementById('inpCategory').value === 'Other';
        document.getElementById('divOther').classList.toggle('hidden', !isOther);
    }

    function saveTransaction() {
        const id = document.getElementById('editId').value;
        const type = document.getElementById('inpType').value;
        const catVal = document.getElementById('inpCategory').value;
        const customCat = document.getElementById('inpOther').value;
        const amount = parseFloat(document.getElementById('inpAmount').value);
        
        if(!amount) return alert("Please enter a valid amount");

        const entry = {
            id: id ? parseFloat(id) : Date.now(),
            date: document.getElementById('inpDate').value,
            type: type,
            category: catVal === 'Other' ? customCat : catVal,
            amount: amount,
            description: document.getElementById('inpDesc').value
        };

        if(id) {
            const index = transactions.findIndex(t => t.id == id);
            if(index !== -1) transactions[index] = entry;
        } else {
            transactions.push(entry);
        }

        saveToCloud();
        closeModal();
    }

    function deleteEntry(id) {
        if(confirm("Are you sure?")) {
            transactions = transactions.filter(t => t.id !== id);
            saveToCloud();
        }
    }

    function saveSettings() {
        appSettings.budget = parseFloat(document.getElementById('setBudget').value) || 0;
        saveToCloud();
        closeSettings();
    }

    // --- DASHBOARD LOGIC ---
    function renderDashboard() {
        const monthFilter = document.getElementById('filterMonth').value;
        const filtered = transactions.filter(t => t.date.startsWith(monthFilter));
        
        // 1. Calculate Stats
        let income = 0, expense = 0;
        const catMap = {};

        filtered.forEach(t => {
            if(t.type === 'Income') income += t.amount;
            else {
                expense += t.amount;
                catMap[t.category] = (catMap[t.category] || 0) + t.amount;
            }
        });

        document.getElementById('dispIncome').innerText = `$${income.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('dispExpense').innerText = `$${expense.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('dispBalance').innerText = `$${(income - expense).toLocaleString(undefined, {minimumFractionDigits: 2})}`;

        // 2. Update Budget Bar
        if(appSettings.budget > 0) {
            const pct = Math.min((expense / appSettings.budget) * 100, 100);
            document.getElementById('budgetMsg').innerText = `Budget: $${appSettings.budget}`;
            document.getElementById('budgetPct').innerText = `${pct.toFixed(0)}% used`;
            const bar = document.getElementById('budgetBar');
            bar.style.width = `${pct}%`;
            bar.style.backgroundColor = pct > 90 ? 'var(--danger)' : (pct > 75 ? 'var(--warning)' : 'var(--primary)');
        } else {
            document.getElementById('budgetMsg').innerText = "No budget set";
            document.getElementById('budgetBar').style.width = "0%";
        }

        // 3. Populate List
        const tbody = document.getElementById('txList');
        tbody.innerHTML = '';
        
        const sorted = [...filtered].sort((a,b) => new Date(b.date) - new Date(a.date));

        sorted.forEach(t => {
            let icon = "ðŸ“¦"; 
            if(categories[t.type] && categories[t.type][t.category]) icon = categories[t.type][t.category];
            
            tbody.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            <span class="cat-icon">${icon}</span>
                            <b>${t.category}</b>
                        </div>
                    </td>
                    <td style="color:var(--text-muted)">${t.description}</td>
                    <td>
                        <span class="badge ${t.type === 'Income' ? 'badge-inc' : 'badge-exp'}">
                            ${t.type === 'Income' ? '+' : '-'}$${t.amount.toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="openModal(${t.id})"><i class="ph ph-pencil-simple"></i></button>
                        <button class="btn-icon" style="color:var(--danger)" onclick="deleteEntry(${t.id})"><i class="ph ph-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        // 4. Update Charts
        updateCharts(catMap, income, expense);
    }

    function updateCharts(catData, inc, exp) {
        const ctxD = document.getElementById('doughnutChart').getContext('2d');
        if(chartInstanceDoughnut) chartInstanceDoughnut.destroy();
        
        chartInstanceDoughnut = new Chart(ctxD, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catData),
                datasets: [{
                    data: Object.values(catData),
                    backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        const ctxB = document.getElementById('barChart').getContext('2d');
        if(chartInstanceBar) chartInstanceBar.destroy();

        chartInstanceBar = new Chart(ctxB, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    label: 'Amount',
                    data: [inc, exp],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- DATA EXPORT/IMPORT ---
    function exportCSV() {
        const month = document.getElementById('filterMonth').value;
        const filtered = transactions.filter(t => t.date.startsWith(month));
        
        if(!filtered.length) return alert("No data to export.");

        let csv = `Finance Report - ${month}\n\nDate,Type,Category,Amount,Description\n`;
        filtered.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            csv += `${t.date},${t.type},${t.category},${t.amount},"${(t.description||'').replace(/"/g,'""')}"\n`;
        });

        const link = document.createElement("a");
        link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        link.download = `Finance_Report_${month}.csv`;
        link.click();
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
        const link = document.createElement("a");
        link.href = dataStr;
        link.download = "finance_backup.json";
        link.click();
    }

    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    transactions = data;
                    // Push restored data to Cloud
                    saveToCloud(); 
                    alert("Data restored and synced to Cloud!");
                } else {
                    alert("Invalid file format.");
                }
            } catch(err) { alert("Error reading file."); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
